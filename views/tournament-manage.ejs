<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage <%= tournament.name %> - Tournament Maker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .match-card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        .match-pending { border-left: 4px solid #6c757d; }
        .match-running { border-left: 4px solid #007bff; }
        .match-completed { border-left: 4px solid #28a745; }
        .opponent-winner { background-color: #d4edda; }
        .opponent-loser { background-color: #f8d7da; }
        .score-input { width: 60px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <i class="bi bi-trophy"></i> Tournament Maker
            </a>
            <div class="d-flex align-items-center text-white">
                <img class="rounded-circle me-2" src="https://cdn.discordapp.com/avatars/<%= user.discordId %>/<%= user.avatar %>.webp?size=40" 
                     alt="Avatar" width="30" height="30">
                <%= user.username %>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Tournament Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1><%= tournament.name %></h1>
                        <p class="text-muted mb-2"><%= tournament.description || 'No description' %></p>
                        <div class="d-flex gap-3">
                            <span class="badge <%= tournament.status === 'active' ? 'bg-success' : tournament.status === 'completed' ? 'bg-secondary' : 'bg-warning' %> fs-6">
                                <%= tournament.status %>
                            </span>
                            <small class="text-muted">
                                <i class="bi bi-calendar"></i> Created <%= new Date(tournament.createdAt).toLocaleDateString() %>
                            </small>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="/tournament/<%= tournament._id %>" class="btn btn-outline-primary">
                            <i class="bi bi-eye"></i> View Brackets
                        </a>
                        <a href="/dashboard" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tournament Data Display -->
        <% if (tournamentData && tournamentData.length > 0) { %>
            <% tournamentData.forEach((stage, stageIndex) => { %>
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-diagram-3"></i> <%= stage.name %> 
                            <span class="badge bg-info"><%= stage.type.replace('_', ' ') %></span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Groups -->
                        <% if (stage.groups && stage.groups.length > 0) { %>
                            <% stage.groups.forEach(group => { %>
                                <% if (stage.groups.length > 1) { %>
                                    <h5 class="mt-3 mb-3">Group <%= group.number %></h5>
                                <% } %>
                                
                                <!-- Rounds -->
                                <% if (group.rounds && group.rounds.length > 0) { %>
                                    <% group.rounds.forEach(round => { %>
                                        <div class="mb-4">
                                            <h6 class="text-muted mb-3">Round <%= round.number %></h6>
                                            
                                            <!-- Matches -->
                                            <% if (round.matches && round.matches.length > 0) { %>
                                                <div class="row">
                                                    <% round.matches.forEach(match => { %>
                                                        <div class="col-md-6 col-lg-4">
                                                            <div class="match-card match-<%= match.status === 0 ? 'pending' : match.status === 1 ? 'running' : 'completed' %>">
                                                                <div class="card-body p-3">
                                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                                        <small class="text-muted">Match <%= match.number %></small>
                                                                        <span class="badge <%= match.status === 0 ? 'bg-secondary' : match.status === 1 ? 'bg-primary' : 'bg-success' %>">
                                                                            <%= match.status === 0 ? 'Pending' : match.status === 1 ? 'In Progress' : 'Completed' %>
                                                                        </span>
                                                                    </div>
                                                                    
                                                                    <!-- Opponents -->
                                                                    <div class="match-opponents">
                                                                        <% if (match.opponent1) { %>
                                                                            <div class="d-flex justify-content-between align-items-center p-2 <%= match.opponent1.result === 'win' ? 'opponent-winner' : match.status === 2 ? 'opponent-loser' : '' %>">
                                                                                <span><%= match.opponent1.name || 'TBD' %></span>
                                                                                <span class="fw-bold"><%= match.opponent1.score !== undefined ? match.opponent1.score : '-' %></span>
                                                                            </div>
                                                                        <% } else { %>
                                                                            <div class="d-flex justify-content-between align-items-center p-2 bg-light">
                                                                                <span class="text-muted">TBD</span>
                                                                                <span>-</span>
                                                                            </div>
                                                                        <% } %>
                                                                        
                                                                        <div class="text-center py-1">
                                                                            <small class="text-muted">VS</small>
                                                                        </div>
                                                                        
                                                                        <% if (match.opponent2) { %>
                                                                            <div class="d-flex justify-content-between align-items-center p-2 <%= match.opponent2.result === 'win' ? 'opponent-winner' : match.status === 2 ? 'opponent-loser' : '' %>">
                                                                                <span><%= match.opponent2.name || 'TBD' %></span>
                                                                                <span class="fw-bold"><%= match.opponent2.score !== undefined ? match.opponent2.score : '-' %></span>
                                                                            </div>
                                                                        <% } else { %>
                                                                            <div class="d-flex justify-content-between align-items-center p-2 bg-light">
                                                                                <span class="text-muted">TBD</span>
                                                                                <span>-</span>
                                                                            </div>
                                                                        <% } %>
                                                                    </div>
                                                                    
                                                                    <!-- Update Match Button -->
                                                                    <% if (match.status !== 2 && match.opponent1 && match.opponent2) { %>
                                                                        <button class="btn btn-sm btn-primary w-100 mt-2 update-match-btn" 
                                                                                data-match-id="<%= match.id %>" 
                                                                                data-opponent1-name="<%= match.opponent1.name || '' %>" 
                                                                                data-opponent2-name="<%= match.opponent2.name || '' %>" 
                                                                                data-opponent1-score="<%= match.opponent1.score || '' %>" 
                                                                                data-opponent2-score="<%= match.opponent2.score || '' %>">
                                                                            <i class="bi bi-pencil"></i> Update Result
                                                                        </button>
                                                                    <% } %>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    <% }) %>
                                                </div>
                                            <% } %>
                                        </div>
                                    <% }) %>
                                <% } %>
                            <% }) %>
                        <% } %>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No tournament data available. The tournament may not have been created properly.
            </div>
        <% } %>
    </div>

    <!-- Update Match Modal -->
    <div class="modal fade" id="updateMatchModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Match Result</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="updateMatchForm">
                        <input type="hidden" id="matchId" name="matchId">
                        
                        <div class="row">
                            <div class="col-6">
                                <h6 id="opponent1Name">Player 1</h6>
                                <div class="mb-3">
                                    <label class="form-label">Score</label>
                                    <input type="number" class="form-control" id="opponent1Score" min="0" required>
                                </div>
                            </div>
                            <div class="col-6">
                                <h6 id="opponent2Name">Player 2</h6>
                                <div class="mb-3">
                                    <label class="form-label">Score</label>
                                    <input type="number" class="form-control" id="opponent2Score" min="0" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Winner</label>
                            <select class="form-select" id="winner" required>
                                <option value="">Select winner...</option>
                                <option value="opponent1">Player 1</option>
                                <option value="opponent2">Player 2</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateMatch()">Update Match</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Add event listeners for update match buttons
        document.addEventListener('DOMContentLoaded', function() {
            const updateButtons = document.querySelectorAll('.update-match-btn');
            updateButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const matchId = this.dataset.matchId;
                    const opponent1Name = this.dataset.opponent1Name;
                    const opponent2Name = this.dataset.opponent2Name;
                    const opponent1Score = this.dataset.opponent1Score;
                    const opponent2Score = this.dataset.opponent2Score;
                    
                    openUpdateMatchModal(matchId, opponent1Name, opponent2Name, opponent1Score, opponent2Score);
                });
            });
        });

        function openUpdateMatchModal(matchId, opponent1Name, opponent2Name, opponent1Score, opponent2Score) {
            document.getElementById('matchId').value = matchId;
            document.getElementById('opponent1Name').textContent = opponent1Name || 'Player 1';
            document.getElementById('opponent2Name').textContent = opponent2Name || 'Player 2';
            document.getElementById('opponent1Score').value = opponent1Score;
            document.getElementById('opponent2Score').value = opponent2Score;
            
            // Update select options
            const winnerSelect = document.getElementById('winner');
            winnerSelect.options[1].text = opponent1Name || 'Player 1';
            winnerSelect.options[2].text = opponent2Name || 'Player 2';
            winnerSelect.value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('updateMatchModal'));
            modal.show();
        }

        async function updateMatch() {
            const matchId = document.getElementById('matchId').value;
            const opponent1Score = parseInt(document.getElementById('opponent1Score').value);
            const opponent2Score = parseInt(document.getElementById('opponent2Score').value);
            const winner = document.getElementById('winner').value;

            if (!winner) {
                alert('Please select a winner');
                return;
            }

            const opponent1Result = winner === 'opponent1' ? 'win' : 'loss';
            const opponent2Result = winner === 'opponent2' ? 'win' : 'loss';

            try {
                const response = await fetch(`/tournament/match/${matchId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        opponent1: { score: opponent1Score, result: opponent1Result },
                        opponent2: { score: opponent2Score, result: opponent2Result }
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // Close modal and reload page
                    bootstrap.Modal.getInstance(document.getElementById('updateMatchModal')).hide();
                    window.location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error updating match:', error);
                alert('Failed to update match. Please try again.');
            }
        }
    </script>
</body>
</html>
